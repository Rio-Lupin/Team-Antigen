<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Demo application for Schrodinger Stack the Future 2026">
  <meta name="keywords" content="hackathon schrodinger">
  <title>

    {% block title %}
    Stack the Future 2026
    {% endblock title %}

  </title>
  <link rel="icon" href='{{ url_for("static", filename="favicon.svg") }}' sizes="any">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    html,
    body {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    /* SVG sizing - fit nicely in card-body */
    .card-body svg {
      max-width: 100%;
      max-height: 300px;
      display: block;
      margin: 0 auto;
    }

    /* Ensure card-body doesn't overflow */
    .card-body {
      overflow: visible;
    }

    /* Keep analytics box size stable, no scroll */
    .analytics-card {
      max-height: 520px;
      overflow: hidden;
    }

    .analytics-card .card-body {
      max-height: 490px;
      overflow: hidden;
    }

    /* Comfortable spacing inside analytics */
    .analytics-card .progress { height: 10px !important; margin-bottom: 10px; }
    .analytics-card .list-group-item { padding: .5rem .75rem; }
    .analytics-card .fw-semibold, .analytics-card h6 { font-size: .95rem; }
    .analytics-card small { font-size: .8rem; }
    .analytics-card .mb-4 { margin-bottom: 1.2rem !important; }
    .analytics-card .mt-3 { margin-top: 1rem !important; }
    .analytics-card .border-bottom { padding-bottom: .5rem !important; }
    .analytics-card .quick-guide { line-height: 1.25; }
    /* Extra bottom padding for caption bullets */
    .analytics-card .quick-guide {
      padding-bottom: 24px;
    }

    /* Space icon to the right of pass/fail text */
    #lipinski-status i { margin-left: 4px; }
  </style>

  {% block styles %}
  {% endblock styles %}

</head>

<body>
  <div class="w-100 h-100 overflow-auto d-flex flex-column justify-content-between">
    <div class="container">

      {% block content %}

      <div class="position-relative pt-5">
        <div class="position-absolute top-0 end-0 mt-2 me-2">
          <button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#infoModal">
            <i class="bi bi-info-circle"></i> Demo Info
          </button>
        </div>

        <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h1 class="modal-title fs-5" id="infoModalLabel">Platform Overview</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="p-3">
                  <h3 class="text-primary mb-4">Accelerating Drug Discovery</h3>
                  <p class="lead">In the chemical industry, synthesizing a single drug candidate takes <strong>6 months
                      and $100,000</strong>, yet 99% of candidates fail in clinical trials.</p>
                  <hr>
                  <p>Our tool helps chemists process scientific data to identify and optimize the 1% that succeed. This
                    demo focuses on drugs targeting proteins that drive <strong>Renal Cell Carcinoma</strong>.</p>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>

        <div class="input-group mb-4">
          <span class="input-group-text">Protein:</span>
          <input id="protein-search-field" class="form-control" type="text" placeholder="Type protein name...">
        </div>

        <div class="row">
          <div class="col-md-7">
            <div id="drugResults"></div>
          </div>

          <div class="col-md-5">
            <div class="card shadow-sm analytics-card">
              <div class="card-body">
                <h5 class="border-bottom pb-2">Molecular Analytics</h5>

                <div class="mb-4 mt-3">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <div class="fw-semibold">Drug-Likeness (QED)</div>
                    </div>
                    <span id="qed-val" class="fw-bold">0.00</span>
                  </div>
                  <div class="progress" style="height: 10px;">
                    <div id="qed-bar" class="progress-bar bg-primary" role="progressbar" style="width: 0%"></div>
                  </div>
                </div>

                <div class="mb-4">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <div class="fw-semibold">Ease of Synthesis (SAScore)</div>
                    </div>
                    <span id="sa-val" class="fw-bold">0.00</span>
                  </div>
                  <div class="progress" style="height: 10px;">
                    <div id="sa-bar" class="progress-bar bg-primary" role="progressbar" style="width: 0%"></div>
                  </div>
                </div>

                <div class="mb-4">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="fw-semibold">Lipinski's Rule of Five</h6>
                    </div>
                    <div class="d-flex align-items-center mb-0">
                      <span id="lipinski-status" class="small"></span>
                    </div>
                  </div>
                  <ul class="list-group list-group-flush small">
                    <li class="list-group-item d-flex justify-content-between">MW: <span id="mw-val">-</span></li>
                    <li class="list-group-item d-flex justify-content-between">LogP: <span id="logp-val">-</span></li>
                    <li class="list-group-item d-flex justify-content-between">H-Donors: <span id="hbd-val">-</span></li>
                    <li class="list-group-item d-flex justify-content-between">H-Acceptors: <span id="hba-val">-</span></li>
                  </ul>
                </div>

                <div class="quick-guide">
                  <h6 class="mb-1">Quick Guide</h6>
                  <ul class="text-muted small mb-0 ps-3">
                    <li>QED: quantitative drug-likeness; higher (0-1) is more drug-like.</li>
                    <li>SAScore: synthesis feasibility; lower (1-10) is easier/cheaper to make.</li>
                    <li>Lipinski: oral drug-likeness checklist (MW ≤ 500, LogP ≤ 5, HBD ≤ 5, HBA ≤ 10).</li>
                  </ul>
                </div>

                <div id="alert-container" class="alert alert-danger d-none">
                  <i class="bi bi-exclamation-triangle-fill"></i> PAINS Alert: <span id="alert-reason"></span>
                </div>
              </div>
            </div>
              </div>
            </div>
          </div>
        </div>

        {% endblock content %}

    </div>
    <div>

      {% block footer %}
      <footer class="d-flex flex-column align-items-center fs-6 text-body-tertiary py-5">
        <span>Stack the Future 2026 - New York, New York</span>
        <span>Copyright &copy; Schrodinger Inc. 2026</span>
      </footer>
      {% endblock footer %}

    </div>
  </div>

  {% block scripts %}
  <script>
    // Global variables to store current drug state
    let currentDrugSmiles = {};
    let currentDrugMetadata = {};

    //Display molecules & SVG's
    document.getElementById('protein-search-field').addEventListener('input', function (e) {
      const proteinName = e.target.value.trim();

      if (proteinName.length < 2) {
        document.getElementById('drugResults').innerHTML = '';
        return;
      }

      // Step 1: Get the drugs for this protein
      fetch(`/api/drugs-by-protein/${proteinName}`)
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            document.getElementById('drugResults').innerHTML = '<p>No drugs found</p>';
            return;
          }

          // Step 2: For EACH drug, fetch its molecule metadata
          const drugPromises = data.drugs.map(drug => {
            // Get the compound_id from your proteins array or use drug name
            return fetch(`/api/molecule-metadata/${drug.name}`)
              .then(res => res.json())
              .then(metadata => {
                // Store metadata for later use
                currentDrugSmiles[drug.name] = drug.smiles;
                currentDrugMetadata[drug.name] = metadata;
                return {
                  name: drug.name,
                  svg: metadata.molecule_svg,
                  smiles: drug.smiles
                };
              })
              .catch(err => ({
                name: drug.name,
                svg: '<p>Error loading molecule</p>',
                smiles: drug.smiles
              }));
          });

          // Step 3: Wait for ALL molecule data, then display
          Promise.all(drugPromises).then(drugsWithMolecules => {
            let html = '<div class="drug-grid row">';

            drugsWithMolecules.forEach(drug => {
              const drugId = `drug-${drug.name.replace(/\s+/g, '-')}`;
              html += `
            <div class="col-md-12 drug-container mb-3">
              <div class="card" data-drug-name="${drug.name}" data-drug-smiles="${drug.smiles}">
                <div class="card-body" id="${drugId}-container">
                  ${drug.svg}
                </div>
                <div class="card-footer">
                  <h5 class="card-title text-center" data-original-name="${drug.name}">${drug.name}</h5>
                  <small class="text-muted d-block text-center">${drug.smiles}</small>
                </div>
              </div>
            </div>
          `;
            });

            html += '</div>';
            document.getElementById('drugResults').innerHTML = html;

            // After adding SVGs, attach click handlers to clickable atoms
            attachAtomClickHandlers();
          });
        })
        .catch(error => {
          console.error('Error:', error);
          document.getElementById('drugResults').innerHTML = '<p>Error loading drugs</p>';
        });
    });


    //MODAL
    // Add click handler for SVG images - put this in your <script> block
    document.addEventListener('click', function (e) {
      // Check if clicked element is a compound image
      if (e.target.classList.contains('card-img-top')) {
        const imageUrl = e.target.src;
        const drugName = e.target.alt;

        // Create modal HTML
        const modalHtml = `
      <div class="modal fade" id="moleculeModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">${drugName}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
              <img src="${imageUrl}" class="img-fluid" style="max-height: 80vh">
            </div>
          </div>
        </div>
      </div>
    `;

        // Remove old modal if exists
        const oldModal = document.getElementById('moleculeModal');
        if (oldModal) oldModal.remove();

        // Add new modal to body
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('moleculeModal'));
        modal.show();

        // Clean up when closed
        document.getElementById('moleculeModal').addEventListener('hidden.bs.modal', function () {
          this.remove();
        });
      }
    });

    //Analytics
    function updateAnalytics(data) {
      // Handle QED (Drug-Likeness) - 0 to 1 scale
      const qed = data.drug_likeness || 0;
      document.getElementById('qed-val').innerText = qed.toFixed(2);
      const qedPercent = Math.round(qed * 100);
      document.getElementById('qed-bar').style.width = qedPercent + '%';
      
      // Handle SAScore (Stability/Ease of Synthesis) - 1 to 10 scale (lower is better)
      const saScore = data.stability_score || 0;
      document.getElementById('sa-val').innerText = saScore.toFixed(1);
      // For SAScore: invert it for progress bar (10 is hardest = 0%, 1 is easiest = 100%)
      const saPercent = Math.round(((10 - saScore) / 9) * 100);
      document.getElementById('sa-bar').style.width = Math.max(0, Math.min(100, saPercent)) + '%';
      
      // Handle Lipinski's Rule of Five
      if (data.lipinski_compliance) {
        const lipinski = data.lipinski_compliance;
        document.getElementById('mw-val').innerText = Math.round(lipinski.molecular_weight || 0);
        document.getElementById('logp-val').innerText = (lipinski.logP || 0).toFixed(2);
        document.getElementById('hbd-val').innerText = Math.round(lipinski.h_donors || 0);
        document.getElementById('hba-val').innerText = Math.round(lipinski.h_acceptors || 0);
        const statusEl = document.getElementById('lipinski-status');
        statusEl.innerHTML = lipinski.complies
          ? 'Pass <i class="bi bi-check-circle-fill text-success"></i>'
          : 'Fail <i class="bi bi-x-circle-fill text-danger"></i>';
      } else {
        // Fallback for old API structure
        document.getElementById('mw-val').innerText = Math.round(data.mw || 0);
        document.getElementById('logp-val').innerText = (data.logp || 0).toFixed(2);
        document.getElementById('hbd-val').innerText = Math.round(data.hbd || 0);
        document.getElementById('hba-val').innerText = Math.round(data.hba || 0);
        const statusEl = document.getElementById('lipinski-status');
        statusEl.innerHTML = 'Not available <i class="bi bi-x-circle-fill text-danger"></i>';
      }
      
      // Handle Structural Alerts (PAINS)
      const alertContainer = document.getElementById('alert-container');
      if (data.structural_alerts && data.structural_alerts.has_alert) {
        document.getElementById('alert-reason').innerText = data.structural_alerts.alert_reason || 'Unknown alert';
        alertContainer.classList.remove('d-none');
      } else {
        alertContainer.classList.add('d-none');
      }
    }

    // Handle when a drug card is clicked (ignore clicks on atom overlays)
    function handleDrugClick(event, drugName, smiles) {
      if (event?.target?.closest('.clickable-atom')) {
        return; // Let atom overlay clicks be handled elsewhere
      }

      fetch(`/api/molecule-metadata/${drugName}`)
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            console.error('Error loading drug metadata:', data.error);
            return;
          }
          // Update analytics with base (unmodified) drug data
          updateAnalytics(data);
          console.log('Drug selected:', drugName);
        })
        .catch(err => console.error('Error loading drug metadata:', err));
    }

    // Attach click handlers to all clickable atom circles
    function attachAtomClickHandlers() {
      // Remove any existing dropdown
      const existingDropdown = document.getElementById('r-group-dropdown');
      if (existingDropdown) {
        existingDropdown.remove();
      }

      // Add click handlers to all clickable atom circles
      document.querySelectorAll('.clickable-atom').forEach(circle => {
        circle.addEventListener('click', function(e) {
          e.stopPropagation(); // Prevent drug card click
          
          const atomId = this.getAttribute('data-atom-id');
          const card = this.closest('.card');
          const drugName = card.getAttribute('data-drug-name');
          const smiles = card.getAttribute('data-drug-smiles') || currentDrugSmiles[drugName];
          const metadata = currentDrugMetadata[drugName];

          if (!metadata || !metadata.r_group_options) {
            alert('R-group options not available for this molecule');
            return;
          }

          if (!smiles) {
            alert('SMILES string not available for this molecule');
            return;
          }

          // Get position of clicked circle for dropdown placement
          const rect = this.getBoundingClientRect();
          
          // Show dropdown menu near the clicked atom
          showRGroupDropdown(rect, drugName, smiles, atomId, metadata.r_group_options);
        });
      });
    }

    // Show R-group dropdown menu
    function showRGroupDropdown(circleRect, drugName, smiles, atomId, rGroupOptions) {
      // Remove existing dropdown if any
      const existingDropdown = document.getElementById('r-group-dropdown');
      if (existingDropdown) {
        existingDropdown.remove();
      }

      // Create dropdown menu
      const dropdown = document.createElement('div');
      dropdown.id = 'r-group-dropdown';
      dropdown.className = 'dropdown-menu show position-fixed';
      dropdown.style.cssText = `
        top: ${circleRect.top + circleRect.height + 10}px;
        left: ${circleRect.left}px;
        min-width: 200px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 9999;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        display: block;
      `;

      // Add header
      const header = document.createElement('div');
      header.className = 'dropdown-header';
      header.innerHTML = `<strong>Select R-group for Atom ${atomId}</strong>`;
      dropdown.appendChild(header);

      // Add R-group options
      Object.keys(rGroupOptions).forEach(groupName => {
        const option = document.createElement('a');
        option.className = 'dropdown-item';
        option.href = '#';
        option.textContent = groupName;
        option.addEventListener('click', function(e) {
          e.preventDefault();
          applyRGroupSubstitution(drugName, smiles, atomId, groupName);
          dropdown.remove();
        });
        dropdown.appendChild(option);
      });

      // Add cancel option
      const divider = document.createElement('div');
      divider.className = 'dropdown-divider';
      dropdown.appendChild(divider);
      
      const cancelOption = document.createElement('a');
      cancelOption.className = 'dropdown-item text-danger';
      cancelOption.href = '#';
      cancelOption.textContent = 'Cancel';
      cancelOption.addEventListener('click', function(e) {
        e.preventDefault();
        dropdown.remove();
      });
      dropdown.appendChild(cancelOption);

      // Add to body
      document.body.appendChild(dropdown);

      // Close dropdown when clicking outside
      setTimeout(() => {
        document.addEventListener('click', function closeDropdown(e) {
          if (!dropdown.contains(e.target) && !e.target.closest('.clickable-atom')) {
            dropdown.remove();
            document.removeEventListener('click', closeDropdown);
          }
        });
      }, 100);
    }

    // Apply R-group substitution
    async function applyRGroupSubstitution(drugName, smiles, atomId, rGroupName) {
      try {
        // Find the drug card
        const card = Array.from(document.querySelectorAll('.card')).find(c => 
          c.getAttribute('data-drug-name') === drugName
        );
        
        if (!card) {
          alert('Could not find drug card');
          return;
        }

        // Show loading indicator on the card
        const loadingIndicator = document.createElement('div');
        loadingIndicator.className = 'alert alert-info position-absolute';
        loadingIndicator.style.cssText = `
          top: 10px;
          left: 50%;
          transform: translateX(-50%);
          z-index: 10000;
          white-space: nowrap;
        `;
        loadingIndicator.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Applying substitution...';
        card.style.position = 'relative';
        card.appendChild(loadingIndicator);

        const response = await fetch('/api/modify-drug', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            smiles: smiles,
            atom_idx: parseInt(atomId),
            new_group: rGroupName
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to modify drug');
        }

        const data = await response.json();

        if (data.success) {
          const container = card.querySelector('.card-body');
          
          // Update the SVG
          if (data.molecule_svg) {
            container.innerHTML = data.molecule_svg;
            
            // Update stored SMILES
            currentDrugSmiles[drugName] = data.new_smiles;
            
            // Update card data attribute
            card.setAttribute('data-drug-smiles', data.new_smiles);
            
            // Update metadata
            if (currentDrugMetadata[drugName]) {
              currentDrugMetadata[drugName].molecule_svg = data.molecule_svg;
            }
            
            // Update drug name to show "drugname-test" and SMILES
            const cardFooter = card.querySelector('.card-footer');
            if (cardFooter) {
              const cardTitle = cardFooter.querySelector('.card-title');
              const smilesText = cardFooter.querySelector('small');
              
              if (cardTitle) {
                // Get original name (set when card is created, preserved for subsequent modifications)
                let originalName = cardTitle.getAttribute('data-original-name');
                if (!originalName) {
                  // Fallback: extract original name by removing '-test' if present
                  const currentText = cardTitle.textContent.trim();
                  originalName = currentText.replace(/-test$/, '');
                  cardTitle.setAttribute('data-original-name', originalName);
                }
                // Update name to "drugname-test" if not already modified
                if (!cardTitle.textContent.includes('-test')) {
                  cardTitle.textContent = `${originalName}-test`;
                }
              }
              
              if (smilesText && data.new_smiles) {
                // Update SMILES string to show the modified molecule
                smilesText.textContent = data.new_smiles;
              }
            }
            
            // Re-attach click handlers to new SVG
            setTimeout(() => {
              attachAtomClickHandlers();
            }, 100);
            
            // Update analytics
            updateAnalytics(data);
            
            console.log(`Applied ${rGroupName} to atom ${atomId} of ${drugName}`);
          }
        } else {
          alert('Error: ' + (data.error || 'Failed to modify drug'));
        }

        loadingIndicator.remove();
      } catch (error) {
        console.error('Error applying R-group substitution:', error);
        alert('Error: ' + error.message);
        document.querySelectorAll('.position-absolute').forEach(el => {
          if (el.innerHTML.includes('spinner')) el.remove();
        });
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('apply-swap-btn')?.addEventListener('click', async () => {
        if (!currentSmiles || selectedAtomIdx === null) {
          alert('Please select an atom first');
          return;
        }
        const newGroup = document.getElementById('r-group-select').value;
        if (!newGroup) {
          alert('Please select an R-group');
          return;
        }
        try {
          const response = await fetch('/api/modify-drug', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              smiles: currentSmiles,
              atom_idx: parseInt(selectedAtomIdx),
              new_group: newGroup
            })
          });
          if (!response.ok) throw new Error('Failed to modify drug');
          const data = await response.json();
          if (data.success) {
            // Update molecule visualization
            if (data.molecule_svg) {
              document.getElementById('molecule-svg-container').innerHTML = data.molecule_svg;
            }
            // Update analytics with the response data
            updateAnalytics(data);
            currentSmiles = data.new_smiles;
          } else {
            alert('Error: ' + (data.error || 'Failed to modify drug'));
          }
        } catch (e) {
          console.error('Error applying swap:', e);
          alert('Error applying swap: ' + e.message);
        }
      });
      document.getElementById('close-drug-btn')?.addEventListener('click', showAllDrugs);
      //loadProteins();
    });
  </script>
  {% endblock scripts %}

</body>

</html>